name: Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run integration tests daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  integration-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Build plugin
      run: mvn clean package -DskipTests

    - name: Verify plugin JAR exists
      run: |
        ls -la target/DragonEggLightning-*.jar
        echo "Plugin JAR size: $(du -h target/DragonEggLightning-*.jar | cut -f1)"

    - name: Wait for Docker daemon
      run: |
        timeout 60 bash -c 'until docker info; do sleep 1; done'
        echo "Docker daemon ready"

    - name: Start Paper server with plugin
      run: |
        docker compose up -d
        echo "Waiting for server to start..."

    - name: Wait for server startup
      run: |
        echo "Checking server logs..."
        timeout 300 bash -c '
          until docker logs papermc-dragonegg 2>&1 | grep -q "Done"; do
            echo "Waiting for server startup..."
            sleep 10
          done
        '
        echo "Server startup completed!"

    - name: Additional wait for plugin loading
      run: |
        echo "Waiting additional time for plugin initialization..."
        sleep 30

    - name: Check plugin loading
      run: |
        echo "Checking for plugin loading messages..."
        PLUGIN_LOGS=$(docker logs papermc-dragonegg 2>&1 | grep -i "dragon")
        if [ -n "$PLUGIN_LOGS" ]; then
          echo "Plugin-related logs found:"
          echo "$PLUGIN_LOGS"
        else
          echo "No plugin logs found yet, checking server health..."
        fi

        # Check if server is running
        if docker ps | grep -q papermc-dragonegg; then
          echo "✅ Server container is running"
        else
          echo "❌ Server container is not running"
          docker logs papermc-dragonegg
          exit 1
        fi

    - name: Create integration test script
      run: |
        cat > integration-test.sh << 'EOF'
        #!/bin/bash
        set -e

        echo "Starting integration tests..."

        # Test 1: Server health check
        echo "Test 1: Server health check..."
        if docker ps | grep -q papermc-dragonegg; then
          echo "✅ Server container is running"
        else
          echo "❌ Server container is not running"
          docker logs papermc-dragonegg --tail 20
          exit 1
        fi

        # Test 2: Check for plugin loading
        echo "Test 2: Checking for plugin loading..."
        PLUGIN_FOUND=false

        # Check multiple times for plugin loading
        for i in {1..10}; do
          sleep 10
          if docker logs papermc-dragonegg 2>&1 | grep -qi "DragonEggLightning"; then
            echo "✅ Plugin mentioned in logs"
            PLUGIN_FOUND=true
            break
          fi
          echo "Attempt $i: Waiting for plugin loading..."
        done

        if [ "$PLUGIN_FOUND" = false ]; then
          echo "⚠️  Plugin not explicitly mentioned in logs, but server is running"
          echo "This might be normal if the plugin loaded without explicit logging"
        fi

        # Test 3: Check server stability
        echo "Test 3: Server stability check..."
        sleep 30  # Additional wait time

        if docker ps | grep -q papermc-dragonegg; then
          echo "✅ Server remained stable"
        else
          echo "❌ Server crashed"
          docker logs papermc-dragonegg --tail 50
          exit 1
        fi

        # Test 4: Verify no critical startup errors
        echo "Test 4: Checking for critical errors..."
        ERROR_COUNT=$(docker logs papermc-dragonegg 2>&1 | grep -i "error\|exception" | grep -v "INFO" | wc -l)
        if [ "$ERROR_COUNT" -eq 0 ]; then
          echo "✅ No critical errors found"
        else
          echo "⚠️  Found $ERROR_COUNT potential errors"
          docker logs papermc-dragonegg 2>&1 | grep -i "error\|exception" | grep -v "INFO" | tail -5
        fi

        # Test 5: Check memory usage
        echo "Test 5: Memory usage check..."
        MEMORY_USAGE=$(docker stats papermc-dragonegg --no-stream --format "table {{.MemUsage}}" | tail -1 | awk '{print $1}' | sed 's/MiB//')
        echo "Memory usage: ${MEMORY_USAGE}MiB"

        if [ "$MEMORY_USAGE" -lt 4096 ]; then
          echo "✅ Memory usage is acceptable"
        else
          echo "⚠️  High memory usage: ${MEMORY_USAGE}MiB"
        fi

        echo "Integration tests completed successfully!"
        EOF
        chmod +x integration-test.sh

    - name: Run integration tests
      run: |
        ./integration-test.sh

    - name: Collect server logs
      if: always()
      run: |
        echo "=== Server logs (last 100 lines) ==="
        docker logs papermc-dragonegg --tail 100
        echo "=== End of logs ==="

    - name: Collect Docker stats
      if: always()
      run: |
        echo "=== Docker stats ==="
        docker stats papermc-dragonegg --no-stream
        echo "=== End of stats ==="

    - name: Stop server
      if: always()
      run: |
        echo "Stopping server..."
        docker compose down
        docker system prune -f

    - name: Upload integration test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: integration-test-results
        path: |
          integration-test.sh
        retention-days: 7

  docker-build-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Test Docker image builds
      run: |
        echo "Testing that Docker Compose configuration is valid..."
        docker compose config > /dev/null
        echo "✅ Docker Compose configuration is valid"

    - name: Build plugin for test
      run: |
        mvn clean package -DskipTests
        echo "Plugin built successfully"

    - name: Test plugin JAR in clean environment
      run: |
        echo "Testing plugin JAR in isolated environment..."
        docker run --rm -v $(pwd)/target:/plugin alpine:latest \
          sh -c '
            ls -la /plugin/DragonEggLightning-*.jar
            file /plugin/DragonEggLightning-*.jar
            if file /plugin/DragonEggLightning-*.jar | grep -q "Java"; then
              echo "✅ JAR file appears to be valid Java bytecode"
            else
              echo "❌ JAR file does not appear to be valid Java bytecode"
              exit 1
            fi
          '
