name: Integration Tests

on:
  push:
    branches: [ main ]
  pull_request:
  # schedule:
  #   # Run integration tests daily at 2 AM UTC
  #   - cron: '0 2 * * *'

jobs:
  integration-test:
    runs-on: ubuntu-latest
    env:
      CONTAINER_NAME: "papermc-dragonegg"
      MEMORYSIZE: "2G"
      EULA: "TRUE"
      TYPE: "PAPER"
      VERSION: "1.21.8"
      ONLINE_MODE: "false"
      MAX_PLAYERS: "20"
      RCON_PORT: "25575"
      RCON_PASSWORD: "minecraft"
      ENABLE_RCON: "true"
      ADMIN_USERNAME: "testplayer"

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Build plugin
      run: mvn clean package -DskipTests

    - name: Verify plugin JAR exists
      run: |
        ls -la target/DragonEggLightning-*.jar
        echo "Plugin JAR size: $(du -h target/DragonEggLightning-*.jar | cut -f1)"

    - name: Wait for Docker daemon
      run: |
        timeout 60 bash -c 'until docker info; do sleep 1; done'
        echo "Docker daemon ready"

    - name: Setup server data from fixtures
      run: |
        cp -r fixtures/server-data ./server-data
        mkdir -p server-data/plugins
        cp target/DragonEggLightning-*.jar server-data/plugins/DragonEggLightning.jar
        echo "Copied server data from fixtures and plugin JAR"
        ls -la server-data/
        ls -la server-data/plugins/

    - name: Start Paper server with plugin
      run: |
        docker compose build
        docker compose up -d
        echo "Waiting for server to start..."

    - name: Show container status
      run: |
        sleep 5
        docker ps -a
        echo "=== Container logs ==="
        docker logs papermc-dragonegg 2>&1 | head -50 || true

    - name: Wait for server startup
      run: |
        echo "Checking server logs..."
        timeout 300 bash -c '
          until docker logs papermc-dragonegg 2>&1 | grep -q "Done"; do
            echo "Waiting for server startup..."
            sleep 10
          done
        '
        echo "Server startup completed!"

    - name: Additional wait for plugin loading
      run: |
        echo "Waiting additional time for plugin initialization..."
        sleep 30

    - name: Check plugin loading
      run: |
        echo "Checking for plugin loading messages..."
        PLUGIN_LOGS=$(docker logs papermc-dragonegg 2>&1 | grep -i "dragon")
        if [ -n "$PLUGIN_LOGS" ]; then
          echo "Plugin-related logs found:"
          echo "$PLUGIN_LOGS"
        else
          echo "No plugin logs found yet, checking server health..."
        fi

        # Check if server is running
        if docker ps | grep -q papermc-dragonegg; then
          echo "✅ Server container is running"
        else
          echo "❌ Server container is not running"
          docker logs papermc-dragonegg
          exit 1
        fi

    - name: Create integration test script
      run: |
        cat > integration-test.sh << 'EOF'
        #!/bin/bash
        set -e

        echo "Starting integration tests..."

        # Test 1: Server health check
        echo "Test 1: Server health check..."
        if docker ps | grep -q papermc-dragonegg; then
          echo "✅ Server container is running"
        else
          echo "❌ Server container is not running"
          docker logs papermc-dragonegg --tail 20
          exit 1
        fi

        # Test 2: Check for plugin loading
        echo "Test 2: Checking for plugin loading..."
        PLUGIN_FOUND=false

        # Check multiple times for plugin loading
        for i in {1..10}; do
          sleep 10
          if docker logs papermc-dragonegg 2>&1 | grep -qi "DragonEggLightning"; then
            echo "✅ Plugin mentioned in logs"
            PLUGIN_FOUND=true
            break
          fi
          echo "Attempt $i: Waiting for plugin loading..."
        done

        if [ "$PLUGIN_FOUND" = false ]; then
          echo "⚠️  Plugin not explicitly mentioned in logs, but server is running"
          echo "This might be normal if the plugin loaded without explicit logging"
        fi

        # Test 3: Check server stability
        echo "Test 3: Server stability check..."
        sleep 30  # Additional wait time

        if docker ps | grep -q papermc-dragonegg; then
          echo "✅ Server remained stable"
        else
          echo "❌ Server crashed"
          docker logs papermc-dragonegg --tail 50
          exit 1
        fi

        # Test 4: Verify no critical startup errors
        echo "Test 4: Checking for critical errors..."
        ERROR_COUNT=$(docker logs papermc-dragonegg 2>&1 | grep -i "error\|exception" | grep -v "INFO" | grep -v -i "eula\|Spigot\|command line" | wc -l)
        if [ "$ERROR_COUNT" -eq 0 ]; then
          echo "✅ No critical errors found"
        else
          echo "⚠️  Found $ERROR_COUNT potential errors"
          docker logs papermc-dragonegg 2>&1 | grep -i "error\|exception" | grep -v "INFO" | grep -v -i "eula\|Spigot\|command line" | tail -5
        fi

        # Test 5: Check memory usage
        echo "Test 5: Memory usage check..."
        MEMORY_RAW=$(docker stats papermc-dragonegg --no-stream --format "table {{.MemUsage}}" | tail -1 | awk '{print $1}')
        # Convert GiB to MiB for comparison (multiply by 1024)
        MEMORY_MIB=$(echo "$MEMORY_RAW" | sed 's/GiB//' | awk '{print int($1 * 1024)}')
        echo "Memory usage: ${MEMORY_RAW} (${MEMORY_MIB}MiB)"

        if [ "$MEMORY_MIB" -lt 4096 ]; then
          echo "✅ Memory usage is acceptable"
        else
          echo "⚠️  High memory usage: ${MEMORY_MIB}MiB"
        fi

        echo "Integration tests completed successfully!"
        EOF
        chmod +x integration-test.sh

    - name: Run integration tests
      run: |
        ./integration-test.sh

    - name: Collect server logs
      if: always()
      run: |
        echo "=== Server logs (last 100 lines) ==="
        docker logs papermc-dragonegg --tail 100
        echo "=== End of logs ==="

    - name: Collect Docker stats
      if: always()
      run: |
        echo "=== Docker stats ==="
        docker stats papermc-dragonegg --no-stream
        echo "=== End of stats ==="

    - name: Stop server
      if: always()
      run: |
        echo "Stopping server..."
        docker compose down
        docker system prune -f

    - name: Upload integration test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: integration-test-results
        path: |
          integration-test.sh
        retention-days: 7

  docker-build-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Build plugin JAR
      run: mvn clean package -DskipTests

    - name: Test Docker build
      run: |
        echo "Testing Docker build with plugin..."
        docker build -t dragon-egg-lightning:test .
        echo "✅ Docker image built successfully"

    - name: Verify plugin JAR in built image
      run: |
        echo "Verifying plugin JAR is present in the Docker image..."
        docker run --rm dragon-egg-lightning:test \
          ls -la /data/plugins/DragonEggLightning.jar
        echo "✅ Plugin JAR found in Docker image"

    - name: Test JAR file integrity
      run: |
        echo "Testing JAR file integrity..."
        JAR_FILE=$(find target -name "DragonEggLightning-*.jar" | head -1)

        if [ -z "$JAR_FILE" ]; then
          echo "❌ No JAR file found"
          exit 1
        fi

        echo "Found JAR: $JAR_FILE"

        # Test JAR can be extracted
        if jar -tf "$JAR_FILE" > /dev/null 2>&1; then
          echo "✅ JAR file can be extracted successfully"
        else
          echo "❌ JAR file extraction failed"
          exit 1
        fi

        # Check for expected contents
        if jar -tf "$JAR_FILE" | grep -q "com/dragonegg/lightning/DragonEggLightningPlugin.class"; then
          echo "✅ Main plugin class found in JAR"
        else
          echo "❌ Main plugin class not found in JAR"
          exit 1
        fi

        if jar -tf "$JAR_FILE" | grep -q "plugin.yml"; then
          echo "✅ Plugin configuration found in JAR"
        else
          echo "❌ Plugin configuration not found in JAR"
          exit 1
        fi

        # Test with unzip as alternative validation
        if unzip -t "$JAR_FILE" > /dev/null 2>&1; then
          echo "✅ JAR file passes unzip validation"
        else
          echo "❌ JAR file fails unzip validation"
          exit 1
        fi

        echo "JAR file size: $(du -h "$JAR_FILE" | cut -f1)"
        echo "All JAR integrity tests passed!"
