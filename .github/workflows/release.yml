name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Get version from pom.xml
      id: get_version
      run: |
        VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=v$VERSION" >> $GITHUB_OUTPUT
        echo "Detected version: $VERSION"

    - name: Create and push tag
      if: github.event_name == 'workflow_dispatch'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Configure git identity for tagging
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        TAG="v${{ steps.get_version.outputs.version }}"
        echo "Creating tag $TAG"

        # Check if tag already exists
        if git rev-parse "$TAG" >/dev/null 2>&1; then
          echo "Tag $TAG already exists locally, deleting it first"
          git tag -d "$TAG"
        fi

        # Create annotated tag
        git tag -a "$TAG" -m "Release version ${{ steps.get_version.outputs.version }}"

        # Push tag to remote
        git push origin "$TAG"
        echo "Tag $TAG created and pushed successfully"

    - name: Build plugin
      run: |
        mvn clean package -DskipTests
        echo "Plugin built successfully"
        ls -la target/DragonEggLightning-*.jar

    - name: Set version outputs for release
      id: version
      run: |
        echo "tag=${{ steps.get_version.outputs.tag }}" >> $GITHUB_OUTPUT
        echo "version=${{ steps.get_version.outputs.version }}" >> $GITHUB_OUTPUT
        echo "JAR_FILE=$(ls target/DragonEggLightning-*.jar | head -1)" >> $GITHUB_OUTPUT

    - name: Generate changelog
      id: changelog
      run: |
        TAG=${{ steps.version.outputs.tag }}
        echo "## Dragon Egg Lightning Plugin v${{ steps.version.outputs.version }}" > CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "ğŸ‰ **New Release Available!**" >> CHANGELOG.md
        echo "" >> CHANGELOG.md

        # Get previous tag
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

        if [ -n "$PREVIOUS_TAG" ]; then
          echo "### ğŸ“ Changes since $PREVIOUS_TAG:" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD >> CHANGELOG.md
        else
          echo "### ğŸš€ Initial Release" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "This is the first release of the Dragon Egg Lightning plugin!" >> CHANGELOG.md
        fi

        echo "" >> CHANGELOG.md
        echo "---" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "## ğŸ“¥ Installation Instructions" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### For Server Administrators:" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "1. **Download** the plugin JAR file below" >> CHANGELOG.md
        echo "2. **Place** it in your Paper server's \`plugins/\` directory" >> CHANGELOG.md
        echo "3. **Restart** your Paper 1.21.8+ server" >> CHANGELOG.md
        echo "4. **Configure** - No additional configuration needed!" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "### For Players:" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "- Get a Dragon Egg: \`/give @p minecraft:dragon_egg\`" >> CHANGELOG.md
        echo "- Move to offhand: Press \`F\` key" >> CHANGELOG.md
        echo "- Use ability: \`/ability 1\`" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "---" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "## âš¡ Features" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "- **3 Sequential Lightning Strikes** with 0.5s intervals" >> CHANGELOG.md
        echo "- **Purple Visual Effects** and thunder sounds" >> CHANGELOG.md
        echo "- **Smart Targeting** - finds closest entity in view" >> CHANGELOG.md
        echo "- **60-Second Cooldown** prevents spam" >> CHANGELOG.md
        echo "- **4.5 Hearts Total Damage** (1.5 per strike)" >> CHANGELOG.md
        echo "- **HUD Display** with real-time cooldown status" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "---" >> CHANGELOG.md
        echo "" >> CHANGELOG.md

        # Add file info
        JAR_FILE=$(ls target/DragonEggLightning-*.jar | head -1)
        JAR_SIZE=$(du -h "$JAR_FILE" | cut -f1)
        echo "## ğŸ“Š Build Information" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "- **Plugin Version**: ${{ steps.version.outputs.version }}" >> CHANGELOG.md
        echo "- **JAR File**: $JAR_FILE" >> CHANGELOG.md
        echo "- **File Size**: $JAR_SIZE" >> CHANGELOG.md
        echo "- **Build Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> CHANGELOG.md
        echo "- **Git Commit**: \`${{ github.sha }}\`" >> CHANGELOG.md
        echo "- **Paper Version**: 1.21.8" >> CHANGELOG.md
        echo "- **Java Version**: 21+" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "---" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "## ğŸ› Issues & Support" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        echo "Report issues: [GitHub Issues](https://github.com/${{ github.repository }}/issues)" >> CHANGELOG.md
        echo "Full documentation: [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)" >> CHANGELOG.md

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: Dragon Egg Lightning Plugin v${{ steps.version.outputs.version }}
        body_path: CHANGELOG.md
        files: |
          target/DragonEggLightning-*.jar
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload plugin JAR as artifact (backup)
      uses: actions/upload-artifact@v4
      with:
        name: plugin-jar-${{ steps.version.outputs.version }}
        path: target/DragonEggLightning-*.jar
        retention-days: 90

    - name: Verify Release Creation
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ğŸ‰ Verifying release creation..."
        echo ""

        # Check if release was created
        if gh release view ${{ steps.version.outputs.tag }} --json id --jq '.id' 2>/dev/null; then
          echo "âœ… Release ${{ steps.version.outputs.tag }} created successfully!"
          echo ""
          echo "ğŸ“¦ Release Assets:"
          gh release view ${{ steps.version.outputs.tag }} --json assets --jq '.assets[] | "  - \(.name): \(.size) bytes"'
          echo ""
          echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"
          echo ""
          echo "ğŸ“¥ Direct Download Link:"
          JAR_FILE=$(ls target/DragonEggLightning-*.jar | head -1 | xargs basename)
          echo "  https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/$JAR_FILE"
        else
          echo "âŒ Failed to create release"
          exit 1
        fi
